Title: SSH Tunneling
Date: 2017-01-02
Modified: 2017-01-02
Tags: ssh, tunneling
Slug: ssh-tunneling
Authors: imjang57
Summary: SSH Tunneling 사용 방법

# SSH Tunneling

SSH(Secure SHell)는 이름에서 알 수 있듯이 보안성이 좋은 프로토콜이다. SSH는 비대칭키를 이용한 인증(Authentication), 대칭키를 이용한 데이터 암호화(Encryption), 네트웍을 통해 전송된 데이터가 변경되지 않았음을 보장하는 무결성(Integrity) 등을 제공한다.

이외에 SSH는 정말 유용한 기능을 제공하는데 바로 포트 포워딩(Port Forwarding)을 이용한 터널링(Tunneling)이다.

SSH 클라이언트가 SSH 서버에 연결되면 둘 사이에 연결이 생성되는데 이를 보통 __터널(Tunnel)__ 이라고 한다. 그리고 이 터널은 클라이언트와 서버 사이에서 암호화로 보호되는 통로이다. 보통은 이 터널을 통해서 클라이언트와 서버가 통신하는데, 포트 포워딩이라는 기술을 사용하면 이 터널을 다른 애플리케이션들이 이용하도록 할 수가 있다. 이를 터널링이라고 한다. 터널링을 사용하면 애플리케이션은 별도로 개발할 필요 없이 SSH의 보안 통로를 사용할 수 있게 되는 것이다. 터널링은 TCP만 가능하고 UDP는 불가능하다.

터널링은 크게 __로컬 포트 포워딩(Local Port Forwarding)__ 과 __리모트 포트 포워딩(Remote Port Forwarding)__ 으로 나누어져 있다. 어디가 요청을 받고 어느 방향으로 전달해주냐에 따라 나누어 진다. 그리고 포트 포워딩을 통한 SSH 터널링은 SSH 연결이 유지되는 동안에만 사용할 수 있다.

# Local Port Forwarding

로컬 포트 포워딩은 SSH 클라이언트가 요청을 받아 SSH 서버를 통해 다른 서버로 요청을 포워딩해주는 것이다. 로컬 포트 포워딩은 다음과 같이 실행하면 사용할 수 있다.

```bash
$ ssh -L<local port number>:<host>:<remote port number> <user>@<SSH server host>[:<SSH server port>]
```

`<local port number>`는 SSH 클라이언트가 애플리케이션을 위해 포트를 열고 대기(LISTEN)하고 있는 포트 번호이다. `<host>`는 애플리케이션이 최종적으로 요청을 전달하려고 하는 서버 주소이다. `<remote port number>`는 애플리케이션이 최종적으로 요청을 전달하려고 하는 서버의 포트 번호이다. 그리고 SSH 연결을 위해 `<user>@<SSH server host>`를 전달한다.

예를 들어, SSH를 통해서만 연결이 가능한 분리된 네트웍이 있다고 하자. 하나는 `192.168.0.0/24`이고 다른 하나는 `192.169.0.0/24`이다. SSH 클라이언트는 `192.168.0.5`, 애플리케이션은 `192.168.0.10`, SSH 서버는 `192.169.0.5:22`, API 서버는 `192.169.0.10:10050`일 때 로컬 호스트에서 로컬 포트 포워딩으로 API 서버에 요청을 하려면 다음과 같이 실행하면 된다.

```bash
$ ssh -L10010:192.169.0.10:10050 myuser@192.169.0.5
```

그리고 애플리케이션은 `192.168.0.5:10010`으로 요청하면 SSH 터널을 통해 API 서버로 요청을 전달할 수 있다. 즉, 애플리케이션 -> SSH 클라이언트 -> SSH 서버 -> API 서버로 전달이 되는 것이다.

# Remote Port Forwaring

리모트 포트 포워딩은 로컬 포트 포워딩과 반대이다. SSH 서버가 요청을 받아 SSH 클라이언트를 통해 다른 서버로 요청을 포워딩해주는 것이다. 리모트 포트 포워딩은 다음과 같이 실행하면 사용할 수 있다.

```bash
$ ssh -R<remote port number>:<host>:<local port number> <user>@<SSH server host>[:<SSH server port>]
```

`<remote port number>`는 SSH 서버가 애플리케이션을 위해 포트를 열고 대기(LISTEN)하고 있는 포트 번호이다. `<host>`는 애플리케이션이 최종적으로 요청을 전달하려고 하는 서버 주소이다. `<local port number>`는 애플리케이션이 최종적으로 요청을 전달하려고 하는 서버의 포트 번호이다. 그리고 SSH 연결을 위해 `<user>@<SSH server host>`를 전달한다.

가만히 보면 로컬 포트 포워딩과 순서가 반대인 것을 알 수 있다. 예를 들어, 예를 들어, SSH를 통해서만 연결이 가능한 분리된 네트웍이 있다고 하자. 하나는 `192.168.0.0/24`이고 다른 하나는 `192.169.0.0/24`이다. SSH 클라이언트는 `192.168.0.5`, API 서버는 `192.168.0.10`, SSH 서버는 `192.169.0.5:22`, 애플리케이션은 `192.169.0.10:10050`일 때 로컬 호스트에서 로컬 포트 포워딩으로 API 서버에 요청을 하려면 다음과 같이 실행하면 된다.

```bash
$ ssh -R10050:192.168.0.10:10010 myuser@192.169.0.5
```

그리고 애플리케이션은 `192.169.0.5:10050`으로 요청하면 SSH 터널을 통해 API 서버로 요청을 전달할 수 있다. 즉, 애플리케이션 -> SSH 서버 -> SSH 클라이언트 -> API 서버로 전달이 되는 것이다.

# 참고사항

SSH 터널링을 이용하면 방화벽을 우회할 수 있고, SSH가 제공하는 암호화된 통신을 쉽게 다른 목적으로도 사용할 수 있다. 그러니 SSH 접근 권한과 관련된 정보(로그인 정보, SSH Key 등)를 잘 관리하자.

